generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "foreignKeys"
}

enum PlatformForJwt {
  WEB
  MOB_IOS
  MOB_ANDROID

  @@map("platform_for_jwt")
}

enum Gender {
  MALE
  FEMALE
  OTHER

  @@map("gender")
}

enum Review {
  VERY_BAD
  BAD
  NORMAL
  GOOD
  VERY_GOOD

  @@map("emotion")
}

enum LegalDocumentType {
  PRIVACY_POLICY
  TERMS_OF_SERVICE

  @@map("legal_document_type")
}

model User {
  id        Int      @id @default(autoincrement())
  isOnline  Boolean  @default(false) @map("is_online")
  email     String   @unique @db.VarChar(255)
  userName  String   @map("user_name") @db.VarChar(255)
  birthDate DateTime @map("birth_date") @db.Timestamptz()
  gender    Gender

  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz()
  socketId         String   @map("socket_id") @db.VarChar(32)
  profileImagePath String?  @map("profile_image_path") @db.VarChar(2047)

  userIdentity         UserIdentity?
  refreshTokens        RefreshToken[]
  feedbacks            Feedback[]
  accountVerifications AccountVerification[]
  recoverPasswords     RecoverPassword[]

  @@index([email])
  @@map("users")
}

model UserIdentity {
  id                Int     @id @default(autoincrement())
  isAccountVerified Boolean @default(false) @map("is_account_verified")
  password          String  @map("password") @db.VarChar(255)
  strictMode        Boolean @default(false) @map("strict_mode")
  isBlocked         Boolean @default(false) @map("is_blocked") // this property can only be removed by admin
  isLocked          Boolean @default(false) @map("is_locked") // this property can be removed by user
  userId            Int     @unique @map("user_id")

  user User @relation(fields: [userId], references: [id])

  @@map("user_identitites")
}

model RefreshToken {
  id                 Int            @id @default(autoincrement())
  userId             Int            @map("user_id")
  token              String
  sub                String
  iss                String
  platform           PlatformForJwt
  exp                String
  jti                String         @unique @db.Uuid()
  iat                String
  cypherIV           String         @map("cypher_iv")
  isUsed             Boolean        @default(false) @map("is_used")
  secretKeyEncrypted String         @map("secret_key_encrypted") @db.VarChar(255)
  createdAt          DateTime       @default(now()) @map("created_at") @db.Timestamptz()

  user User @relation(fields: [userId], references: [id])

  @@index([jti], type: BTree)
  @@map("refresh_tokens")
}

model AccountVerification {
  id            Int       @id @default(autoincrement())
  securityToken String    @map("security_token")
  jti           String    @unique @db.Uuid()
  userId        Int       @map("user_id")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz()

  acountVerificationAttemptCount AccountVerificationAttemptCount?
  user                           User                             @relation(fields: [userId], references: [id])

  @@map("account_verifications")
}

/// This database will be for checking for too many requests if count is 5 and 
/// {some_amount} of time is not passed yet by checking created_at other insert will be blocked
/// after successfull verification all column will be deleted
model AccountVerificationAttemptCount {
  id                          Int       @id @default(autoincrement())
  count                       Int       @default(0) @db.SmallInt
  countIncreaseLastUpdateDate DateTime? @map("count_increase_last_update_date") @db.Timestamptz()
  accountVerificationId       Int       @unique @map("account_verification_id")
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  deletedAt                   DateTime? @map("deleted_at") @db.Timestamptz()

  accountVerification AccountVerification @relation(fields: [accountVerificationId], references: [id])

  @@map("account_verifications_attempt_count")
}

model RecoverPassword {
  id            Int       @id @default(autoincrement())
  securityToken String    @map("security_token")
  jti           String    @unique @db.Uuid()
  userId        Int       @map("user_id")
  newPassword   String    @map("new_password") @db.VarChar(255)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz()

  recoverPasswordAttemptCount RecoverPasswordAttemptCount?
  user                        User                         @relation(fields: [userId], references: [id])

  @@map("recover_passwords")
}

/// Same logic as account verification
/// for more info see table description found in account_verifications_attempt_count
model RecoverPasswordAttemptCount {
  id                          Int       @id @default(autoincrement())
  count                       Int       @default(0) @db.SmallInt
  countIncreaseLastUpdateDate DateTime? @map("count_increase_last_update_date") @db.Timestamptz()
  recoverPasswordId           Int       @unique @map("recover_password_id")
  createdAt                   DateTime  @default(now()) @map("created_at") @db.Timestamptz()
  deletedAt                   DateTime? @map("deleted_at") @db.Timestamptz()

  recoverPassword RecoverPassword @relation(fields: [recoverPasswordId], references: [id])

  @@map("recover_passwords_attempt_count")
}

model LegalDocument {
  id        Int               @id @default(autoincrement())
  title     String            @db.VarChar(255)
  type      LegalDocumentType @unique
  updatedAt DateTime          @updatedAt @map("updated_at") @db.Timestamptz()
  createdAt DateTime          @default(now()) @map("created_at") @db.Timestamptz()

  paragraphs LegalDocumentParagraph[]

  @@map("legal_documents")
}

model LegalDocumentParagraph {
  id        Int      @id @default(autoincrement())
  title     String   @db.VarChar(255)
  content   String   @db.Text
  index     Int
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  legalDocument   LegalDocument @relation(fields: [legalDocumentId], references: [id])
  legalDocumentId Int           @map("legal_document_id")

  @@map("legal_document_paragraphs")
}

model Feedback {
  id        Int      @id @default(autoincrement())
  text      String   @db.Text
  review    Review
  images    String[]
  userId    Int      @map("user_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  user User @relation(fields: [userId], references: [id])

  @@map("feedbacks")
}
